---
created: 2023-11-15T20:54
updated: 2023-11-15T20:54
---
# tcp/ip

## 相关基础知识

### ack:acknowledge

### syn: synchronous,是TCP/IP建立连接时使用的握手信号

- 英文含义

	- 文章

### [文章：tcp当主动发出syn_搞懂TCP/IP协议看这篇就够了](https://blog.csdn.net/weixin_34430692/article/details/112412253)

### 三次握手过程

- 目的：

	- 同步序列号，只有同步序列号之后才能实现可靠传输。
	- 三次握手的信号由TCP头部中的 SYN标志位和 32位序列号两个部分实现。

- 过程

	- 1.第一次握手：client给server发送连接请求报文，在这个报文中，包含了SYN=1，client_seq=任意值i，发送之后处于SYN-SENT状态；
	- 2.第二次握手：server端接收到了这个请求，并分配资源，同时给client返回一个ACK报文，这个报文中包含了标志位SYN和ACK都为1，而小ack为i+1，此时位于SYN-RCVD状态；
	- 3.第三次握手：client收到server发来的ACK信息后，他会看到server发过来的小ack是i+1，这时他知道了server收到了消息，也给server回一个ACK报文，报文中包含了ACK=1和client_ack=k+1字段；连接建立，client进入established(已建立连接)状态。

- 三次握手，比较清晰的图解

	- 图示

### 三次握手类比图示：

### 服务器半连接队列

- 图示：
- 在服务器第一次收到SYN信号后，服务器状态切换为SYN_RCV，同时维护一个队列来保存未完成的信息，一旦这个队列溢出，则无法建立新的连接。这个队列称为， 半连接队列。 半连接队列 由长度不仅需要tcp_max_syn_backlog，还有backlog和somaxconn的值(控制accept队列大小)共同控制。
- SYN泛洪攻击发生在此处，攻击的就是这个半连接队列。攻击者不断向服务器发出请求之后就消失，造成服务器端的资源耗尽。 

	- 解决办法： tcp_syn_cookies功能开启后可以在不使用半连接队列的情况下成功建立连接。 工作原理为，服务器根据当前状态计算出一个哈希值， 放在SYN+ACK中一同发出，当客户端返回ACK报文时，去除该值验证，如果合法则认为建立连接成功。

### 服务器端全连接队列

- 建立连接成功后，半连接队列移除，将新的连接添加到全连接队列。 全连接 队列的 长度由somaxconn和backlog之间的最小值决定。 somaxconn是内核参数，backlog是lisen中的第二个参数。

### 丢包 VS 复位

- 在新的连接无法连接时，TCP 默认采用丢包的方式处理后面的请求。可以用netstat -s 查看丢弃连接的情况，输出值为累计值：
- 图示

### RTT

- RTT(Round-Trip Time): 往返时延。在计算机网络中它是一个重要的性能指标，表示从发送端发送数据开始，到发送端收到来自接收端的确认（接收端收到数据后便立即发送确认），总共经历的时延。

	- 一般认为单向时延=传输时延t1+传播时延t2+排队时延t3
	- t1是数据从进入节点到传输媒体所需要的时间，通常等于数据块长度/信道带宽
	- t2是信号在信道中需要传播一定距离而花费的时间，等于信道长度/传播速率（光纤中电磁波的传播速率约为2*10^5 km/s，铜缆中2.3*10^5 km/s）
	- t3可笼统归纳为随机噪声，由途径的每一跳设备及收发两端负荷情况及吞吐排队情况决定(包含互联网设备和传输设备时延)
	- 综上：时延并无标准值只有经验值。某运营商规定网内路由器间时延1000公里之内<=40ms,2000公里之内<=60ms,3000公里之内<=80ms

### TCP四次挥手

- 特点

	- RST暴力关闭方式和FIN四次挥手流程
	- 关闭连接的函数有两种： 关闭两头的close函数和只关闭一方的shutdown函数。四次挥手是温柔的断开方式，只有FIN和ACK两种信号。
	- 要注意的是， 主动发起关闭的一方会有time_wait阶段。

- 过程

	- 第一次挥手：client给server发送一个FIN报文，挥手之后client进入FIN_WAIT_1的第一阶段；
	- 第二次挥手：server收到client发来的FIN报文后，给client返回一个ACK信息，并且ack=seq+1，server进入CLOSE_WAIT阶段，而client收到之后处于FIN_WAIT_2；
	- 第三次挥手：当server发完所有数据时，他会给client发送一个FIN报文，告诉client说“我传完数据了，现在要关闭连接了”，server变成LAST_ACK状态，等着client最后的ACK信息；
	- 第四次挥手：当client收到这个FIN报文时，server发ACK信息，但是它怕server收不到信息，所以进入TIME_WAIT状态，等待server确认收到这个ACK信息则正式关闭了tcp连接，进入CLOSED状态。

- 图示

	- 

### 提升

### [文章：跟着动画学习TCP三次握手和四次挥手](https://mp.weixin.qq.com/s/pSrKbVryn71kDVIXUtpXMA)

## TCP/IP过程

### 当输入 URL 时，整个过程是什么样子的

- 图示

### TCP/IP协议图示

- 图：OSI七层模型，TCP/IP四层模型，TPC/IP协议栈

	- TCP/IP四层模型

		- 应用层：应用程序间沟通的层，如简单电子邮件传输（SMTP）、文件传输协议（FTP）、网络远程访问协议（Telnet）等。
		- 传输层：在此层中，它提供了节点间的数据传送服务，如传输控制协议（TCP）、用户数据报协议（UDP）等，TCP和UDP给数据包加入传输数据并把它传输到下一层中，这一层负责传送数据，并且确定数据已被送达并接收。

			- 发送

		- 网络层：负责提供基本的数据封包传送功能，让每一块数据包都能够到达目的主机（但不检查是否被正确接收），如网际协议（IP）。

			- 寻址

		- 网络接口层：与硬件驱动对话，对实际的网络媒体的管理，定义如何使用实际网络
		- 举例：

			- 比如一个QQ软件，发送某条消息的时候，都会经历过次四层  ，                      hello
			- 经过应用层之后，发送的消息会被加上QQ应用标识                              app+hello
			- 经过传输层之后  ，发送的消息带着QQ应用标识再被加上tcp标记，成了一个TCP段   ， tcp+app+hello
			- 经过网络层之后，再刚刚的数据上再加上ip标记，标识这个带着QQ标记的消息，要发送到哪个IP去   ip+tcp+app+hello  变成了一个数据包
			- 经过接口层之后，把刚刚数据包加上帧头和帧尾   帧头+ip+tcp+app+hello+帧尾  ，这样就变成了完整的数据包 ，可以在网络上传输了
			- 然后这一整个东西，经过各种通信设备，到达了对方机器之后，再经过反向的层层数据剥离，传输到对方的QQ上

		- 理解

			- “我们在传输数据时，可以只使用（传输层）TCP/IP协议，但是那样的话，如果没有应用层，便无法识别数据内容，如果想要使传输的数据有意义，则必须使用到应用层协议，应用层协议有很多，比如HTTP、FTP、TELNET等，也可以自己定义应用层协议。WEB使用HTTP协议作应用层协议，以封装HTTP 文本信息，然后使用TCP/IP做传输层协议将它发到网络上。”
			- “IP”代表网际协议，TCP和UDP使用该协议从一个网络传送数据包到另一个网络。把 IP想像成一种高速公路，它允许其它协议在上面行驶并找到到其它电脑的出口。
			- TCP和UDP是高速公路上的“卡车”，它们携带的货物就是像HTTP，文件传输协议FTP这样的协议等。
			-  HTTP(超文本传输协议)是利用TCP在两台电脑(通常是Web服务器和客户端)之间传输信息的协议。客户端使用Web浏览器发起HTTP请求给Web服务器，Web服务器发送被请求的信息给客户端。

		- 不同的TCP/IP和其他的协议在最初OSI模型

- OSI七层模型总结
- TCP/IP模型与OSI模型各层的对照关系

	- TCP/IP协议族按照层次由上到下，层层包装。

		- 最上面的是应用层，这里面有http，ftp,等等我们熟悉的协议。
		- 而第二层则是传输层，著名的TCP和UDP协议就在这个层次。
		- 第三层是网络层，IP协议就在这里，它负责对数据加上IP地址和其他的数据以确定传输的目标。
		- 第四层是数据链路层，这个层次为待传送的数据加入一个以太网协议头，并进行CRC编码，为最后的数据传输做准备。

- 表示了TCP/IP协议中每个层的作用

	- 上图清楚地表示了TCP/IP协议中每个层的作用，而TCP/IP协议通信的过程其实就对应着数据入栈与出栈的过程。入栈的过程，数据发送方每层不断地封装首部与尾部，添加一些传输的信息，确保能传输到目的地。出栈的过程，数据接收方每层不断地拆除首部与尾部，得到最终传输的数据。

### http协议图示

- 数据发送过程

## 数据链路层

### 物理层负责0、1比特流与物理设备电压高低、光的闪灭之间的互换。 

### 数据链路层负责将0、1序列划分为数据帧从一个节点传输到临近的另一个节点,这些节点是通过MAC来唯一标识的(MAC,物理地址，一个主机会有一个MAC地址)。

### 图示

### 封装成帧: 把网络层数据报加头和尾，封装成帧,帧头中包括源MAC地址和目的MAC地址。

### 透明传输:零比特填充、转义字符。

### 可靠传输: 在出错率很低的链路上很少用，但是无线链路WLAN会保证可靠传输。

### 差错检测(CRC):接收者检测错误,如果发现差错，丢弃该帧。

## 网络层

### 1. IP协议

- 概念

	- P协议是TCP/IP协议的核心，所有的TCP，UDP，IMCP，IGMP的数据都以IP数据格式传输。
	- 要注意的是，IP不是可靠的协议，这是说，IP协议没有提供一种数据未传达以后的处理机制，这被认为是上层协议：TCP或UDP要做的事情。

- 1.1 IP地址

	- 在数据链路层中我们一般通过MAC地址来识别不同的节点，而在IP层我们也要有一个类似的地址标识，这就是IP地址。
	- 32位IP地址分为网络位和地址位，这样做可以减少路由器中路由表记录的数目，有了网络地址，就可以限定拥有相同网络地址的终端都在同一个范围内，那么路由表只需要维护一条这个网络地址的方向，就可以找到相应的这些终端了。
	- A类IP地址: 0.0.0.0~127.255.255.255
	- B类IP地址:128.0.0.0~191.255.255.255
	- C类IP地址:192.0.0.0~239.255.255.255

- 1.2 IP协议头

	- 图示
	- 这里只介绍:八位的TTL字段。这个字段规定该数据包在穿过多少个路由之后才会被抛弃。某个IP数据包每穿过一个路由器，该数据包的TTL数值就会减少1，当该数据包的TTL成为零，它就会被自动抛弃。
	- 这个字段的最大值也就是255，也就是说一个协议包也就在路由器里面穿行255次就会被抛弃了，根据系统的不同，这个数字也不一样，一般是32或者是64。

### 2. ARP及RARP协议

- ARP 是根据IP地址获取MAC地址的一种协议。
- ARP（地址解析）协议是一种解析协议，本来主机是完全不知道这个IP对应的是哪个主机的哪个接口，当主机要发送一个IP包的时候，会首先查一下自己的ARP高速缓存（就是一个IP-MAC地址对应表缓存）。
- 如果查询的IP－MAC值对不存在，那么主机就向网络发送一个ARP协议广播包，这个广播包里面就有待查询的IP地址，而直接收到这份广播的包的所有主机都会查询自己的IP地址，如果收到广播包的某一个主机发现自己符合条件，那么就准备好一个包含自己的MAC地址的ARP包传送给发送ARP广播的主机。
- 而广播主机拿到ARP包后会更新自己的ARP缓存（就是存放IP-MAC对应表的地方）。发送广播的主机就会用新的ARP缓存数据准备好数据链路层的的数据包发送工作。
- RARP协议的工作与此相反，不做赘述。

### 3. ICMP协议

- IP协议并不是一个可靠的协议，它不保证数据被送达，那么，自然的，保证数据送达的工作应该由其他的模块来完成。其中一个重要的模块就是ICMP(网络控制报文)协议。ICMP不是高层协议，而是IP层的协议。
- 当传送IP数据包发生错误。比如主机不可达，路由不可达等等，ICMP协议将会把错误信息封包，然后传送回给主机。给主机一个处理错误的机会，这 也就是为什么说建立在IP层以上的协议是可能做到安全的原因。

## ping

### ping可以说是ICMP的最著名的应用，是TCP/IP协议的一部分。利用“ping”命令可以检查网络是否连通，可以很好地帮助我们分析和判定网络故障。

- 例如：当我们某一个网站上不去的时候。通常会ping一下这个网站。ping会回显出一些有用的信息。一般的信息如下:
- ping这个单词源自声纳定位，而这个程序的作用也确实如此，它利用ICMP协议包来侦测另一个主机是否可达。原理是用类型码为0的ICMP发请 求，受到请求的主机则用类型码为8的ICMP回应。
- ping程序来计算间隔时间，并计算有多少个包被送达。用户就可以判断网络大致的情况。我们可以看到， ping给出来了传送的时间和TTL的数据。

## Traceroute

### Traceroute是用来侦测主机到目的主机之间所经路由情况的重要工具，也是最便利的工具。

### Traceroute的原理是非常非常的有意思，它收到到目的主机的IP后，首先给目的主机发送一个TTL=1的UDP数据包，而经过的第一个路由器收到这个数据包以后，就自动把TTL减1，而TTL变为0以后，路由器就把这个包给抛弃了，并同时产生 一个主机不可达的ICMP数据报给主机。主机收到这个数据报以后再发一个TTL=2的UDP数据报给目的主机，然后刺激第二个路由器给主机发ICMP数据 报。如此往复直到到达目的主机。这样，traceroute就拿到了所有的路由器IP。

### 图示

## 六、TCP/UDP

### TCP/UDP都是是传输层协议，但是两者具有不同的特性，同时也具有不同的应用场景，下面以图表的形式对比分析。

### 图示

### 面向报文

- 面向报文的传输方式是应用层交给UDP多长的报文，UDP就照样发送，即一次发送一个报文。因此，应用程序必须选择合适大小的报文。若报文太长，则IP层需要分片，降低效率。若太短，会是IP太小。

### 面向字节流

- 面向字节流的话，虽然应用程序和TCP的交互是一次一个数据块（大小不等），但TCP把应用程序看成是一连串的无结构的字节流。TCP有一个缓冲，当应用程序传送的数据块太长，TCP就可以把它划分短一些再传送。

### TCP和UDP协议的一些应用

### 什么时候应该使用TCP？

- 当对网络通讯质量有要求的时候，比如：整个数据要准确无误的传递给对方，这往往用于一些要求可靠的应用，比如HTTP、HTTPS、FTP等传输文件的协议，POP、SMTP等邮件传输的协议。

### 什么时候应该使用UDP？

- 当对网络通讯质量要求不高的时候，要求网络通讯速度能尽量的快，这时就可以使用UDP。

## 七、DNS

### DNS（Domain Name System，域名系统），因特网上作为域名和IP地址相互映射的一个分布式数据库，能够使用户更方便的访问互联网，而不用去记住能够被机器直接读取的IP数串。通过主机名，最终得到该主机名对应的IP地址的过程叫做域名解析（或主机名解析）。DNS协议运行在UDP协议之上，使用端口号53。

### 网际层协议：包括：IP协议、ICMP协议、ARP协议、RARP协议。 传输层协议：TCP协议、UDP协议。 应用层协议：FTP、Telnet、SMTP、HTTP、RIP、NFS、DNS

### [文章：应用层协议：DNS域名系统](https://blog.csdn.net/zyhmz/article/details/80490534?utm_term=dns%E5%B1%9E%E4%BA%8E%E4%BB%80%E4%B9%88%E5%B1%82%E5%8D%8F%E8%AE%AE&utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~all~sobaiduweb~default-1-80490534&spm=3001.4430)

## 八、TCP连接的建立与终止

## [文章地址：](https://www.toutiao.com/i6570218601117123080/?wid=1631159026384#comment_area)

## TCPIP / LAN、WAN、、VLAN、WLAN 和 WIFI 的区别和联系

### 一、LAN

- 英文全称：Local Area Network 。
- 中文名称：局域网。
- 定义：指在某一区域内由多台计算机互联成的计算机组。

### 二、WAN

- 英文全称：Wide Area Network 。
- 中文名称：广域网。
- 定义：一种跨越大的、地域性的计算机网络的集合。子网可以是局域网也可以是小型的广域网。

### 三、VLAN

- 英文全称：Virtual Local Area Network 。
- 中文名称：虚拟局域网。
- 定义：指网络中的站点不拘泥于所处的物理位置，根据需要灵活划分不同的逻辑子网中的一种网络技术。
- [vlan是什么，为什么要创建它，即使小白看一遍也能学会](https://baijiahao.baidu.com/s?id=1648461810048002485&wfr=spider&for=pc)

### 四、WLAN

- 英文全称：Wireless Local Area Network 。
- 中文名称：无线局域网。
- 定义：利用电磁波在空气中发送和接受数据，而无需线缆介质的局域网。
- 其他：WLAN 使用 ISM (Industrial、Scientific、Medical) 无线电广播频段通信。WLAN 的 802.11a 标准使用 5 GHz 频段，支持的最大速度为 54 Mbps，而 802.11b 和 802.11g 标准使用 2.4 GHz 频段，分别支持最大 11 Mbps 和 54 Mbps 的速度。

### 五、WIFI

- 英文全称：Wireless Fidelity。
- 中文名称：无线保真。
- 定义：一种无线网络传输技术。实际上是将有线网络信号转换成无线网络信号，供设备使用。
- 和WLAN的关系：
- （1）WIFI 是 WLAN 的一个标准，WIFI 包含于 WLAN 中，属于采用 WLAN 协议中的一项新技术。
- （2）无线路由器的发射功率一般都在 50 毫瓦以下，也就是 100 米范围内，如果达到 300 米距离的话，大概要到 75-80 毫瓦。而WLAN发射信号的基站功率就大多了，家庭用的一般是在100—300mw，电信级的一般都在400mw以上。

